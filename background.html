<script>

	var links = null;
	chromeRadioStoragePrefix = "mp3_url:";

	
	// *********** LISTENERS **************
	
	// this listener gets content_script results when user changed active tab
	chrome.tabs.onSelectionChanged.addListener(function(tabId, info) {

		updateLinks(tabId);

	});
	
	// this listener gets content_script results when user created a new tab
	chrome.tabs.onCreated.addListener(function(tab) {
		updateLinks(tab.id);
	});
	
	// this listener gets content_script results when tab changed somehow
	chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
		updateLinks(tabId);
	});
	
	// LISTENER THAT UPDATES THE BADGE WHEN A LINK COUNT IS BEING SENT FROM CONTENT-SCRIPT.

	chrome.extension.onRequest.addListener(
	function(request, sender, sendResponse) {
		
		console.log(request);
		//alert(links);
		if (request == null)
		{
			chrome.browserAction.setBadgeText({text:"0"});	
			chrome.extension.getURL("popup.html").updateList();	
		}
		else
		{
			if(request.playme){
		
				chrome.tabs.create({url:"my-library.html"});
				chrome.extension.getURL("my-library.html").playme({});
			
			}

			links = request;
			chrome.browserAction.setBadgeText({text:links.length.toString()});
			chrome.extension.getURL("popup.html").updateList();		
		}


		sendResponse({}); 
	});
	
	// *********** LOCAL STORAGE **************
	
	// simply add new mp3 without a message
	// this is called in popup.html
	function addToLibrary(href,text)
	{
		setItem(chromeRadioStoragePrefix+href, text);
	}
	
	// check for popup.html if given mp3 already is in local storage.
	function mp3IsInLibrary(href)
	{
		console.log("checking: "+href);
		if(getItem(chromeRadioStoragePrefix+href) != null)
		{
			return true;
		}
		else
		{
			return false;
		}
	}
	
	function setItem(key, value) {
	  try {
		window.localStorage.removeItem(key);
		window.localStorage.setItem(key, value);
	  }catch(e) {
	  }
	}

	//Gets the item from local storage with the specified key
	function getItem(key) {
	  var value;
	  try {
		value = window.localStorage.getItem(key);
	  }catch(e) {
		//value = "null";
		return null;
	  }
	  return value;
	}
	
	// ************************
	
	function updateLinks(tabId)
	{
		chrome.tabs.sendRequest(tabId,{update:"true"});
	}
	
	function playFile(href)
	{
		chrome.extension.sendRequest({playme:href});	
	}
	

</script>
