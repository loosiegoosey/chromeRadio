<html>
<head>
<script>

	var insert = "";
	
	// call background.html to add a new link to library
	function addFileToLibrary(ref)
	{
		var mp3div = ref.parentNode;
		var link = mp3div.childNodes[0];
		var button = mp3div.childNodes[1];
		chrome.extension.getBackgroundPage().addToLibrary(link.href,link.innerHTML);
		mp3div.removeChild(button);
	}
	
	// link-node with add-button
	function addMP3LinkNode(href,text)
	{
		insert+="<div class=\"mp3linknode\"><a onClick=\"play(this.href);\" href=\""+href+"\">"+text+"</a><input type=\"button\" value=\"Add To Library\" onClick=\"addFileToLibrary(this);\"></div>";	
	}
	
	// link-node without add-button
	function addMP3LinkNodeNoButton(href,text)
	{
		insert+="<div class=\"mp3linknode\"><a onClick=\"play(this.href);\" href=\""+href+"\">"+text+"</a></div>";	
	}
	
	function updateList()
	{
		var target = document.getElementById("links_found");
		var bgLinks = chrome.extension.getBackgroundPage().links;
		
		var currentPageLinks = bgLinks.length;
		
		insert = "";
		
		for(i = 0; i < bgLinks.length; i++)
		{
			// check if that mp3 is already in library and decide whether to show add-button
			
			if (chrome.extension.getBackgroundPage().mp3IsInLibrary(bgLinks[i].href) == true)
			{
				addMP3LinkNodeNoButton(bgLinks[i].href, bgLinks[i].text);
			}
			else
			{
				addMP3LinkNode(bgLinks[i].href, bgLinks[i].text);
			}	
		}
		
		target.innerHTML = insert;
	}
	
	function play(href)
	{
		console.log("PLAY: "+href);
		var playertarget = document.getElementById("player_area");
		playertarget.innerHTML = genPlayerLink(href);
	}
	
	function genPlayerLink(href)
	{
		return "<audio autoplay controls src=\""+href+"\"></audio>";
	}

</script>
</head>
<body onLoad="updateList()" style="width:300px;";>
    <p>MP3-Links found:</p>
	<p id="player_area"></p>
    <p id="links_found"></p>
<h2>My Library</h2>
<p><a href="my-library.html" target="_blank">View My Library</a></p>
  </body>
</html>
